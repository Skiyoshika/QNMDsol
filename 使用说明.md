# 🧠 Neurostick 使用说明书
**Neurostick (原 QNMDsol, v0.1 Demo)**

欢迎使用 **Neurostick**！这是一款专为《艾尔登法环》、《噬血代码》等高难度动作游戏设计的脑机接口控制系统。通过读取您的脑电波（或面部肌电信号），将其转化为虚拟手柄指令，实现“意念”玩游戏。

本文档将指导您配置环境、连接设备以及进行全流程测试。

---

## 📋 1. 环境准备 (Prerequisites)

在运行程序之前，请确保您的电脑满足以下条件：

### 🛠️ 硬件需求
* **OpenBCI 头戴设备:** Cyton 板卡 + Daisy 扩展板 (共16通道)。
* **USB 接收器 (Dongle):** 需插入电脑 USB 接口。
* *注意：串口端口可在 Neurostick 界面中直接选择（下拉框）。如果连接失败，请先在设备管理器确认实际端口号（例如 `COM3/COM4/...`），再回到软件里切换。*

### 💻 软件需求
1.  **操作系统:** Windows 10 或 Windows 11 (64位)。
2.  **vJoy 虚拟手柄驱动:**
    * 请下载并安装 **vJoy v2.2.2.0**（建议使用该版本以避免兼容性问题）：
      https://github.com/BrunnerInnovation/vJoy/releases/tag/v2.2.2.0
    * 安装完成后，运行 vJoy 配置工具 `vJoyConf.exe`，确保创建并启用 **Device 1**：
      1) 打开 `vJoyConf.exe`（通常在 `C:\\Program Files\\vJoy\\` 目录）
      2) 选择 `Device 1`
      3) 轴（Axes）至少勾选：`X`、`Y`、`Rx`、`Ry`
      4) Buttons 建议设置为 `12`（或更多）
      5) POV/方向帽（可选）：需要十字键时可设置 1 个 POV
      6) 点击 `Apply` 保存
    * 验证：按 `Win + R` 输入 `joy.cpl` 打开“设置 USB 游戏控制器”，确认 `vJoy Device` 存在且测试页面的十字/轴会变化。
3.  **核心驱动文件 (DLL):**
    为了防止程序启动/连接时闪退，运行目录（Neurostick 可执行文件同级目录，或仓库根目录）**必须** 包含以下文件：
    * `BoardController.dll`
    * `DataHandler.dll`
    * `vJoyInterface.dll`

    **这些 DLL 从哪里来？**
    * 本仓库根目录已内置上述 DLL（Windows x64），正常情况下不需要额外下载。
    * 如果你自行清理/丢失了 DLL：
      - `BoardController.dll` / `DataHandler.dll`：从 BrainFlow 的 Windows x64 发布包中获取并放回运行目录。
      - `vJoyInterface.dll`：可从 vJoy 安装目录复制（常见路径：`C:\\Program Files\\vJoy\\x64\\vJoyInterface.dll`），或直接放到运行目录。

---

## 🎮 2. 运行模式说明
在终端运行以下命令启动程序：

```bash
cargo run
```

启动后，左侧控制面板提供两种模式：SIM (模拟) 和 REAL (真实)。

**🅰️ SIM 模式 (全真模拟)**
用途： 在没有佩戴设备时，测试软件逻辑、界面显示和 vJoy 手柄映射是否正常。 原理： 使用 键盘按键 来模拟大脑产生特定信号，从而触发手柄动作。

**重要提示：**
* SIM 模式下的键盘输入只在 **Neurostick 窗口获得焦点**时生效（这是正常的）。
* Steam 的“按下 A 键/检测输入”界面监听的是 **vJoy 设备输入**，不是键盘输入；因此在做 Steam Input 绑定时，建议用 `joy.cpl` 先确认 vJoy 有输出，或直接用 REAL 模式让 EEG 在后台驱动 vJoy。

操作步骤：

在左上角选择 SIM。

点击 CONNECT (连接模拟器)。

点击 START STREAM (开始数据流)。此时你会看到波形图开始滚动。

键盘控制 (模拟脑波):

W / A / S / D: 推懂虚拟手柄的 左摇杆 (移动)。

I / J / K / L: 推懂虚拟手柄的 右摇杆 (视角)。

空格键 (Space): 触发 A 键 (跳跃/确认)。

Z / X / C: 分别触发 B / X / Y 键。

现象：按下键盘时，波形图会产生剧烈波动，左侧的手柄可视化面板会实时点亮对应的按键。

# 3. 硬件连接 (REAL MODE)

当你完成 Steam Input 的配置后（**详见 README.md 2.1 节**），可以开始进行真实硬件的测试。

## 3.1 首次佩戴与信号质量检查

**请务必先完成这一步，否则后续校准会失败。**

1.  **佩戴：** 戴好你的脑电帽，确保电极与头皮接触良好（通常湿润的电极接触效果最佳）。
2.  **连接：** 在 Neurostick 界面选择 **REAL** 模式。
3.  **启动：** 点击 **CONNECT**，然后点击 **START STREAM**。
4.  **观察波形：**
    * **良好信号：** 实时 EEG 曲线应为一条比较平稳的细线，或有规律的 Alpha 波（闭眼放松时）。
    * **❌ 信号不良（Rail）：** 如果曲线出现巨大的方波或一直在上限和下限之间震荡，表示电极接触不良。请调整电极位置，直到波形稳定。

## 3.2 意念阈值校准 (Calibration)

**当前版本（`main`）使用简单的“阈值触发演示”**：采集两段 3 秒窗口并计算触发阈值，用于驱动 vJoy 输出。

1.  在 Neurostick 界面，选择 **Calibration** 选项卡。
2.  **静息态采集（Baseline, 3s）**
    * 点击 **“1. 录制静息 (3s)”**，保持放松、尽量不眨眼不咬牙，等待 3 秒结束。
3.  **动作态采集（Action, 3s）**
    * 点击 **“2. 录制动作 (3s)”**，执行你的目标意念动作（更推荐运动想象：想象走路/抬脚/握拳等），等待 3 秒结束。
4.  **自动计算**
    * 采集完成后，界面会显示 **Threshold（阈值）**，并用它来触发手柄输出。
    * 如果触发太容易：提高阈值；如果触发太难：降低阈值或重新录制。

## 3.3 功能面板速查（当前 `main` 所有功能）
- **连接控制**：CONNECT / START STREAM / STOP。CONNECT 会打开串口（REAL）或键盘模拟器（SIM）；START STREAM 开始采集；STOP 关闭数据流。
- **波形视图**：实时滚动显示各通道原始信号；点击 **Reset View** 可清空历史曲线重新绘制。
- **频谱视图**：显示 FFT 频谱幅值，可切换窗口函数（Hann/Hamming/Blackman）和 FFT 长度，用于快速检查 Alpha/Beta 等频段。
- **Calibration 选项卡**：按顺序点击 **Record Relax (3s)** / **Record Action (3s)** 计算演示阈值。阈值滑块可手动调节灵敏度。
- **Impedance 选项卡**：估算每个通道的阻抗区间并标记（Good / Acceptable / Poor / Railed），用于快速排查电极接触问题。
- **AI Data Collection**：输入任意标签（如 `Attack` / `Rest`），点击 🔴 RECORD / ⏹ STOP，将 EEG 数据保存为 CSV（保存在仓库根目录，可用于 `trainer/` 离线训练）。
- **AI Model UI**：设置 `brain_model.json` 路径，点击 **LOAD** / **RELOAD** 加载占位模型，并在状态栏显示占位类别概率（实时推理尚未接入 `engine`）。
- **vJoy 输出预览**：左侧面板实时显示虚拟手柄按键/摇杆状态，方便在进游戏前确认 SIM 按键或 REAL 阈值触发是否正确传到 vJoy。

## 3.4 游戏内实战测试 (Field Test)

1.  **运行 Neurostick：** 启动程序，选择 **REAL** 模式，进行连接和串流。
2.  **运行《艾尔登法环》：** 通过 Steam 启动游戏。
3.  **桌面联调 (可选)：** 打开 Windows 的 **“设置 USB 游戏控制器”** (`joy.cpl`)，观察在你进行意念活动时，vJoy 设备的按键或摇杆是否能被触发。
4.  **游戏内测试：** 进入游戏安全区（如篝火旁），测试你的意念活动是否能成功触发：
    * **咬牙** -> 角色挥刀/攻击？
    * **左手意念** -> 角色向左移动？

如果在游戏中无法触发，请返回 **3.2 阈值校准** 重新录制（静息更放松、动作更明确），或在左侧面板手动调整阈值。

---

## 💾 4. AI 数据采集 (Data Collection)
为了训练个性化的 AI 模型，您需要录制自己的脑波数据。

注意：此功能仅在 REAL 模式下可用。

连接硬件并开始推流 (Start Stream)。

在左侧 AI DATA COLLECTION 下方的文本框输入标签名。

例如输入：Attack (代表攻击动作) 或 Rest (代表放松)。

点击 🔴 RECORD 开始录制。

此时请执行对应的动作（如用力咬牙，或保持放松）。

点击 ⏹ STOP 结束录制。

数据将自动保存为 .csv 文件，位于项目根目录下。

---

## 🔧 5. 常见问题 (FAQ)
Q: 点击 CONNECT 后程序直接闪退？

A: 99% 是因为缺少 DLL 文件。请确保 BoardController.dll 就在 .exe 旁边或者项目根目录下。

Q: 报错 "Port Open Failed"?

A: 请检查 USB Dongle 是否插好；检查是否有其他软件（如 OpenBCI GUI）正在占用这个 COM 口。

Q: 模拟模式下，按键盘手柄没反应？

A: 请确保你点击了 START STREAM，并且选中了程序窗口（使其获得焦点）。

Q: 波形图太乱了怎么办？

A: 点击左侧的 🔄 RESET VIEW 按钮可以清空当前波形，重新绘制。

---

**Neurostick - Made by Independent Developer.**

## AI 流程 (离线演示)
- 进入 	rainer 运行 un_all.bat，自动转换外部 EEGMI 数据并训练 CSP+LDA，生成根目录 rain_model.json。
- 左侧面板可设置模型路径并加载/重载；右侧状态栏显示模型输出概率（无真实推理时为随机占位，便于演示 UI）。
- 当前类映射：left/right/fists/feet，用于演示。真实前进/后退/转向需用你的帽子采集目标标签再重训。
