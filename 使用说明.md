# 🧠 QNMDsol 使用说明书
**Quick Neural Mind-Driven Souls-like Controller (v0.1 Demo)**

欢迎使用 **QNMDsol**！这是一款专为《艾尔登法环》、《噬血代码》等高难度动作游戏设计的脑机接口控制系统。通过读取您的脑电波（或面部肌电信号），将其转化为虚拟手柄指令，实现“意念”玩游戏。

本文档将指导您配置环境、连接设备以及进行全流程测试。

---

## 📋 1. 环境准备 (Prerequisites)

在运行程序之前，请确保您的电脑满足以下条件：

### 🛠️ 硬件需求
* **OpenBCI 头戴设备:** Cyton 板卡 + Daisy 扩展板 (共16通道)。
* **USB 接收器 (Dongle):** 需插入电脑 USB 接口。
    * *注意：代码默认端口为 `COM4`。如果您的端口不同，请在设备管理器查看并在代码中修改。*

### 💻 软件需求
1.  **操作系统:** Windows 10 或 Windows 11 (64位)。
2.  **vJoy 虚拟手柄驱动:**
    * 请下载并安装 [vJoy](https://github.com/shauleiz/vJoy/releases)。
    * 安装后，请确保配置了一个默认的虚拟设备 (Device 1)。
3.  **核心驱动文件 (DLL):**
    为了防止程序闪退，您的项目根目录 (`E:\QNMDsol\`) **必须** 包含以下文件：
    * `BoardController.dll`
    * `DataHandler.dll`
    * `vJoyInterface.dll`

---

## 🎮 2. 运行模式说明
在终端运行以下命令启动程序：

```bash
cargo run
```

启动后，左侧控制面板提供两种模式：SIM (模拟) 和 REAL (真实)。

**🅰️ SIM 模式 (全真模拟)**
用途： 在没有佩戴设备时，测试软件逻辑、界面显示和 vJoy 手柄映射是否正常。 原理： 使用 键盘按键 来模拟大脑产生特定信号，从而触发手柄动作。

操作步骤：

在左上角选择 SIM。

点击 CONNECT (连接模拟器)。

点击 START STREAM (开始数据流)。此时你会看到波形图开始滚动。

键盘控制 (模拟脑波):

W / A / S / D: 推懂虚拟手柄的 左摇杆 (移动)。

I / J / K / L: 推懂虚拟手柄的 右摇杆 (视角)。

空格键 (Space): 触发 A 键 (跳跃/确认)。

Z / X / C: 分别触发 B / X / Y 键。

现象：按下键盘时，波形图会产生剧烈波动，左侧的手柄可视化面板会实时点亮对应的按键。

# 3. 硬件连接 (REAL MODE)

当你完成 Steam Input 的配置后（**详见 README.md 2.1 节**），可以开始进行真实硬件的测试。

## 3.1 首次佩戴与信号质量检查

**请务必先完成这一步，否则后续校准会失败。**

1.  **佩戴：** 戴好你的脑电帽，确保电极与头皮接触良好（通常湿润的电极接触效果最佳）。
2.  **连接：** 在 QNMDsol 界面选择 **REAL** 模式。
3.  **启动：** 点击 **CONNECT**，然后点击 **START STREAM**。
4.  **观察波形：**
    * **良好信号：** 实时 EEG 曲线应为一条比较平稳的细线，或有规律的 Alpha 波（闭眼放松时）。
    * **❌ 信号不良（Rail）：** 如果曲线出现巨大的方波或一直在上限和下限之间震荡，表示电极接触不良。请调整电极位置，直到波形稳定。

## 3.2 意念阈值校准 (Calibration)

**阈值决定了你“意念”的敏感程度。这一步是确保游戏可玩性的关键！**

1.  在 QNMDsol 界面，选择 **Calibration** 选项卡。
2.  **静息态采集 (Baseline):**
    * 点击 **“Start Baseline”**，保持 3-5 秒静息状态（发呆、放松，不进行任何意念或肌肉活动）。
3.  **峰值态采集 (Peak Signal):**
    * 点击 **“Start Peak”**，进行你想要触发动作的意念活动（例如：想象握紧左拳，或用力咬牙）。
4.  **自动计算：** QNMDsol 会根据两次采集结果，自动计算出一个 **Trigger Threshold（触发阈值）**。
    * **调整：** 如果触发太容易，你可以手动调高阈值；如果太难，可以调低。

## 3.3 游戏内实战测试 (Field Test)

1.  **运行 QNMDsol：** 启动程序，选择 **REAL** 模式，进行连接和串流。
2.  **运行《艾尔登法环》：** 通过 Steam 启动游戏。
3.  **桌面联调 (可选)：** 打开 Windows 的 **“设置 USB 游戏控制器”** (`joy.cpl`)，观察在你进行意念活动时，vJoy 设备的按键或摇杆是否能被触发。
4.  **游戏内测试：** 进入游戏安全区（如篝火旁），测试你的意念活动是否能成功触发：
    * **咬牙** -> 角色挥刀/攻击？
    * **左手意念** -> 角色向左移动？

如果在游戏中无法触发，请返回 **3.2 阈值校准**，调整你的 Trigger Threshold。

---

## 💾 4. AI 数据采集 (Data Collection)
为了训练个性化的 AI 模型，您需要录制自己的脑波数据。

注意：此功能仅在 REAL 模式下可用。

连接硬件并开始推流 (Start Stream)。

在左侧 AI DATA COLLECTION 下方的文本框输入标签名。

例如输入：Attack (代表攻击动作) 或 Rest (代表放松)。

点击 🔴 RECORD 开始录制。

此时请执行对应的动作（如用力咬牙，或保持放松）。

点击 ⏹ STOP 结束录制。

数据将自动保存为 .csv 文件，位于项目根目录下。

---

## 🔧 5. 常见问题 (FAQ)
Q: 点击 CONNECT 后程序直接闪退？

A: 99% 是因为缺少 DLL 文件。请确保 BoardController.dll 就在 .exe 旁边或者项目根目录下。

Q: 报错 "Port Open Failed"?

A: 请检查 USB Dongle 是否插好；检查是否有其他软件（如 OpenBCI GUI）正在占用这个 COM 口。

Q: 模拟模式下，按键盘手柄没反应？

A: 请确保你点击了 START STREAM，并且选中了程序窗口（使其获得焦点）。

Q: 波形图太乱了怎么办？

A: 点击左侧的 🔄 RESET VIEW 按钮可以清空当前波形，重新绘制。

---

**QNMDsol - Made by Independent Developer.**

## AI 流程 (离线演示)
- 进入 	rainer 运行 un_all.bat，自动转换外部 EEGMI 数据并训练 CSP+LDA，生成根目录 rain_model.json。
- 左侧面板可设置模型路径并加载/重载；右侧状态栏显示模型输出概率（无真实推理时为随机占位，便于演示 UI）。
- 当前类映射：left/right/fists/feet，用于演示。真实前进/后退/转向需用你的帽子采集目标标签再重训。
